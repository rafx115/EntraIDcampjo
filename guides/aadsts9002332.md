# AADSTS9002332: Application '{principalId}'({principalName}) is configured for use by Microsoft Entra users only. Please do not use the /consumers endpoint to serve this request.


## Troubleshooting Steps
### Troubleshooting Guide for Error Code AADSTS9002332

**Error Description:**  
`AADSTS9002332 - Application '{principalId}'({principalName}) is configured for use by Microsoft Entra users only. Please do not use the /consumers endpoint to serve this request.`

This error indicates that the application in question is configured to only accept authentication requests from Microsoft Entra (formerly Azure AD) users and not from personal Microsoft accounts. If a request is made using the `/consumers` endpoint, you will encounter this error.

---

### 1. Initial Diagnostic Steps

- **Identify the Application:** First, ascertain which application and its credentials (client ID, secret, etc.) are being used when the error occurs.
- **Check Scope of the Request:** Confirm the endpoint being accessed. Is it targeting Azure AD (v1.0 or v2.0) or the Microsoft account endpoint (consumers)?
- **Review Application Properties:** Use the Azure portal to review the application's registration and settings to verify its type and configuration.

---

### 2. Common Issues that Cause this Error

- **Configuration Mismatch:** The application is set to allow only organizational (Entra) accounts but is being accessed as if it's a personal Microsoft account.
- **Endpoint Misuse:** The request is being routed to the `/consumers` endpoint rather than the appropriate Entra endpoint.
- **Misconfigured Redirect URIs:** The redirects defined in the app registration might be pointing to the wrong endpoints.
- **Invalid Scopes:** The scopes requested may not align with what is defined or expected by the application.

---

### 3. Step-by-Step Resolution Strategies

#### Step 1: Verify Application Type

1. Go to the **Azure Portal**.
2. Navigate to **Azure Active Directory** > **App registrations**.
3. Locate your application using the Application ID or name.
4. Review the "Authentication" section and confirm that it's set to "Accounts in this organizational directory only" for Entra user authentication.

#### Step 2: Adjust the Endpoint Used in Requests

1. Ensure that your application requests authentication against the correct endpoint:
   - For Microsoft Entra (Azure AD users only): Use `https://login.microsoftonline.com/{tenantId}/oauth2/v2.0/token` or `https://login.microsoftonline.com/{tenantId}/authorize` for authorization.
   - Avoid using endpoints that contain `/consumers`.

#### Step 3: Update Redirect URIs

1. In the **Azure Portal**, under your app registration, navigate to the **Authentication** blade.
2. Make sure the redirect URIs used match the endpoints you're routing users to and are appropriate for organizational users.

#### Step 4: Adjust Scope and Permissions

1. Ensure that the scopes requested during authentication align with what has been set in the app registration.
2. Review the **API permissions** section to ensure the correct permissions are granted for the requested scopes.

---

### 4. Additional Notes or Considerations

- **User Experience:** Inform users if access is restricted to organization accounts only, and ensure proper messaging is displayed on the frontend.
- **Testing:** Make sure to test the application with a valid Entra organizational account to ensure that the functionality is working correctly without hitting the error.
- **Environment Variables:** If you're using a configuration file or environment variables for settings, double-check to ensure that the endpoint and identifiers are correct.

---

### 5. Documentation for Guidance

- Microsoft Azure AD Application Registration: [Azure Active Directory app registration](https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app)
- Understanding Azure AD and Azure AD B2C: [Azure AD vs Azure AD B2C](https://docs.microsoft.com/azure/active-directory/develop/authentication-scenarios)
- Authentication and authorization in Azure AD: [Understanding authentication and authorization](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios)

**Test Documentation Accessibility:**  
You can verify the availability of the documents by clicking the links provided above directly in your web browser.

---

### 6. Advice for Data Collection

- **Kusto Queries:** If you're utilizing Azure AD logs or Kusto queries, gather logs related to the time of the error to find additional context about the request.
- **Application Logs:** Collect any error logs from the application that might provide further insight into why the request was misrouted.
- **User Queries:** Collect basic user info such as whether the accounts in question are indeed Microsoft Entra accounts. 

---

By following this guide, you should be able to diagnose and resolve the AADSTS9002332 error effectively.