# AADSTS230109: CachedCredentialNonGWAuthNRequestsNotSupported - Backup Auth Service only allows AuthN requests from Microsoft Entra Gateway. This error is returned when traffic targets the backup auth service directly instead of going through the reverse proxy.


## Troubleshooting Steps
Certainly! Below is a detailed troubleshooting guide for the error code **AADSTS230109** with the description **CachedCredentialNonGWAuthNRequestsNotSupported**.

---

## Troubleshooting Guide for AADSTS230109

### Initial Diagnostic Steps
1. **Understand the Error**: This error indicates that authentication requests were directed to the backup authentication service rather than the Microsoft Entra (formerly Azure AD) Gateway. 

2. **Check the Application Configuration**: Verify the application and authentication service configuration to ensure that they correctly route requests through the Microsoft Entra Gateway.

3. **Review Logs**: Examine logs from your application for any unexpected configurations or patterns that lead to incorrect gateway targeting.

<<<<<<< HEAD
### Common Issues that Cause This Error
- **Direct Requests to Backup Authentication Service**: Application or service configuration may direct requests to the backup authentication endpoint instead of through the Microsoft Entra Gateway.
  
- **Networking Issues**: Network configurations or proxy settings might incorrectly route traffic directly to the backup service.
=======
#### Additional Notes or Considerations:
- It�s essential to follow the specified authentication flow requirements to avoid errors related to direct access to the backup auth service.
- Regular monitoring and review of network configurations can help prevent such errors in the future.
>>>>>>> 44a6fd6d2b08a07d1c083c6d7db8bca24b23c735

- **Outdated SDK/Library**: If your application uses outdated libraries for Microsoft authentication, it may not be routing correctly.

- **Custom Proxy Configurations**: If a custom reverse proxy is in place, it may not be properly routing authentication requests.

### Step-by-Step Resolution Strategies

#### Step 1: Verify Service Routing
1. **Check DNS Settings**: Ensure that the DNS settings correctly resolve to the Microsoft Entra Gateway and not the backup service.
  
2. **Policy and Firewall Rules**: Review any policies or firewall rules that could prevent traffic from reaching the gateway.

#### Step 2: Application Configuration
1. **Check Application Settings**: Ensure your application is configured to use the correct authority URLs that point to the gateway.
   - Look for `https://login.microsoftonline.com/{tenant}` and ensure it is not pointing to a backup or alternate URL.

2. **Review Middleware/Proxy Configurations**: If using middleware (like ASP.NET middleware), ensure that it correctly integrates with Microsoft Entra.

#### Step 3: Update Libraries
1. **Upgrade SDKs**: Ensure your application uses the latest version of libraries for Microsoft authentication. For example, if using Microsoft Authentication Library (MSAL), ensure it�s the latest version.

2. **Refer to Library Documentation**: Follow guidance from the official libraries' documentation on proper configuration.

#### Step 4: Proxy or Reverse Proxy Settings
1. **Check Reverse Proxy Logs**: Review your reverse proxy logs to see if requests are sent to the unauthorized endpoint.

2. **Adjust Reverse Proxy Rules**: Make sure the requests are being forwarded correctly to the Microsoft Entra Gateway.

### Additional Notes or Considerations
- **Test in Different Environments**: If possible, replicate your setup in a test environment to isolate issues without affecting production systems.
- **Documentation and Community Resources**: Leverage Microsoft documentation and community forums. Consider Microsoft's Azure support for deeper insights.

### Documentation for Guidance
- [Microsoft Entra Authentication Overview](https://learn.microsoft.com/en-us/azure/active-directory/develop/authentication-scenarios)
- [Troubleshooting Azure Active Directory Authentication](https://learn.microsoft.com/en-us/azure/active-directory/develop/authentication-troubleshooting)
- [Using Microsoft Authentication Library (MSAL)](https://learn.microsoft.com/en-us/azure/active-directory/develop/msal-overview)

#### Test the Documentation
To ensure the documentation is reachable, click on the links provided above or enter them into your browser to confirm they load properly.

### Advice for Data Collection
1. **Collect Logs**: Gather logs from the application, the reverse proxy, and any Azure logs.
2. **Network Packet Capture**: If needed, perform a packet capture to analyze traffic and verify whether requests are reaching the correct endpoint.
3. **User Impact Assessment**: Document any affected users or services to inform your team in case escalation is needed.

--- 

By following this comprehensive guide, you should be able to effectively troubleshoot the AADSTS230109 error and implement any necessary resolutions.