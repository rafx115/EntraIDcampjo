# AADSTS700005: InvalidGrantRedeemAgainstWrongTenant - Provided Authorization Code is intended to use against other tenant, thus rejected. OAuth2 Authorization Code must be redeemed against same tenant it was acquired for (/common or /{tenant-ID} as appropriate)


## Troubleshooting Steps
### Troubleshooting Guide for AADSTS700005: Invalid Grant Redeem Against Wrong Tenant

The error code `AADSTS700005` indicates an issue with an OAuth2 authorization code being redeemed against the wrong tenant. This typically happens when the authorization code obtained from Azure Active Directory (AAD) is used in a different tenant than it was generated for.

#### Initial Diagnostic Steps

1. **Identify the Context of the Error**:
   - Determine when the error occurs. Is it during a specific action, such as login or token exchange?
   - Check the specific tenant and application involved in the authentication process.

2. **Gather Authentication Details**:
   - Collect the authorization code being used.
   - Identify the tenant from which the code was obtained and the tenant against which it is being redeemed.

3. **Authentication Flow**:
   - Review the flow used for authorization. Is it the correct OAuth2 flow for your application?

#### Common Issues That Cause This Error

1. **Misconfigured Application**:
   - The application might be configured incorrectly in the Azure portal, leading to mismatches.
   - The redirect URIs may not match those registered for the application.

2. **Different Tenants**:
   - The authorization code was requested from one tenant but is being used in another tenant. This often happens with multi-tenant applications.

3. **Scopes and Permissions**:
   - The requested scopes may not match the permissions granted for the tenant.

4. **Tokens Expired or Malformed**:
   - The authorization code itself may be expired or incorrectly formatted.

#### Step-by-Step Resolution Strategies

1. **Confirm Tenant Alignment**:
   - Verify the tenant ID associated with the application registration in Azure AD.
   - Check that the authorization code is acquired from the same tenant.

2. **Check Application Registration**:
   - Go to the Azure portal and check the application registration for the app in question.
   - Ensure that the settings (Redirect URIs, Application ID, Client Secret, etc.) are configured correctly.

3. **Decide on Single vs. Multi-Tenant Identity**:
   - If your application is multi-tenant, ensure that users are signing in with the correct tenant context.
   - If it’s single-tenant, ensure tenants match.

4. **Re-generate Authorization Code**:
   - If possible, request a new authorization code ensuring you use the intended tenant's endpoint.
   - For example, use `https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/authorize` for a specific tenant, and avoid using `/common` unless necessary.

5. **Test with Postman or an API Client**:
   - Use a tool like Postman to manually test the OAuth flow. Validate that you're receiving the authorization code from the expected tenant.

6. **Review and Correct Redirect URI**:
   - Confirm the redirect URI used to receive the authorization code matches the one registered in Azure AD.

7. **Inspect Logs for Errors**:
   - Check application and audit logs in Azure AD to look for any specific messages related to authentication failures.

#### Additional Notes or Considerations

- If you’re developing multiple applications or services, always make sure that shared configurations are aligned to avoid tenant mismatches.
- Consider using state parameters in OAuth 2.0 flows to maintain context, which can help in troubleshooting.

#### Documentation for Further Guidance

- Microsoft Authentication Libraries (MSAL) and OAuth2 documentation:
  - [Microsoft Authentication Library (MSAL)](https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-overview)
  - [OAuth 2.0 Authorization Code Flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow)

#### Test the Documentation Reachability

You can check the reachability of the documentation by visiting:
- [MSAL Overview](https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-overview)
- [OAuth 2.0 Authorization Code Flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow)

Both links should load with Microsoft documentation.

#### Advice for Data Collection

- Capture the full HTTP request and response including headers for your authorization call and token exchange:
  - Include status codes, bodies, and any error messages returned by Azure AD.
- Log tenant information, application IDs, and the authorization codes involved for diagnostics.
- If possible, enable Azure AD auditing to trace authentication events.

By following these guidelines, you can effectively troubleshoot and resolve the AADSTS700005 error in your application integration with Azure Active Directory.