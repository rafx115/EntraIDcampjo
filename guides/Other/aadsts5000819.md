# AADSTS5000819: InvalidSamlTokenEmailMissingOrInvalid - SAML Assertion is invalid. Email address claim is missing or doesn't match domain from an external realm.


## Troubleshooting Steps
### Troubleshooting Guide for AADSTS5000819: InvalidSamlTokenEmailMissingOrInvalid

When the error code AADSTS5000819 is encountered, it indicates that there is a problem with the SAML assertion being passed from an external identity provider (IdP). Specifically, this error means that either the email address claim is missing, invalid, or does not match the expected domain. Here we provide a thorough guide to diagnose and resolve this issue.

#### Initial Diagnostic Steps

1. **Check the Error Context**: Identify the context in which the error occurred. Note the URL, application, or service trying to authenticate.

2. **Review SAML Assertion**:
   - Use tools like SAML-tracer (a browser extension) to capture the SAML assertion.
   - Examine the assertion for the presence of an `email` claim, and note its format and value.

3. **Inspect the Authentication Logs**: Check the logs in the Azure Active Directory (AAD) for any additional information related to the failed authentication attempt.

#### Common Issues that Cause This Error

1. **Missing Email Claim**: The SAML assertion does not contain an email claim, which is usually expected by Azure AD.

2. **Invalid Email Format**: The value present in the email claim is incorrectly formatted.

3. **Domain Mismatch**: The email claim exists and is well-formed but uses a domain that is not recognized or allowed by the application (e.g., not part of the associated Azure AD tenant).

4. **Claims Mapping Configuration**: The claims mapping in the AAD is incorrectly configured, causing it not to recognize the email claim from the assertion.

5. **Token Expiration**: Although not directly related to email claims, expired tokens can cause SAML assertions to fail.

#### Step-by-Step Resolution Strategies

1. **Check SAML Assertion for Email Claim**:
   - Capture and decode the SAML assertion; look for `<saml:Attribute Name="email">`.
   - If the claim is missing, work with the source IdP to ensure it provides the required email claim.

2. **Validate Email Format**:
   - Confirm that the email address follows standard formats (e.g., `user@domain.com`).

3. **Domain Validation**:
   - Ensure the domain of the email claim matches the expected domain in Azure AD.
   - If necessary, add the external domain as a verified domain in Azure AD.

4. **Claims Mappings**:
   - In the Azure AD portal, navigate to App Registrations > [Your Application] > Token Configuration.
   - Verify the claims mapping settings to ensure the email claim is correctly mapped.

5. **Contact the Identity Provider**:
   - If the email claim is causing issues, reach out to the IdP to modify their SAML assertion configuration.

6. **Test with Different Accounts**:
   - Use different user accounts to determine if the issue is user-specific or applies to all accounts.

7. **Review Application Logs**:
   - Check the logs of the application receiving the SAML assertion to see if more context is provided.

#### Additional Notes or Considerations

- Ensure that updates made are tested in a safe environment before deploying to production.
- Review both the Azure AD configuration and the configuration on the IdP side to ensure consistency.
- Consider potential differences in behavior for different users based on their domain affiliation.

#### Documentation for Guidance

- Microsoft Documentation on [SAML Authentication for Azure AD](https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-saml-technical-overview)
- Azure AD Claims Mapping documentation: [Understanding Claims Mapping](https://learn.microsoft.com/en-us/azure/active-directory/develop/active-directory-claims-mapping)
- SAML overview and troubleshooting: [SAML-based SSO in Azure AD](https://learn.microsoft.com/en-us/azure/active-directory/develop/active-directory-saml-protocol)

#### Test the Documentation Reachability

- Ensure to open the links provided above to confirm they are reachable and display relevant information.

#### Advice for Data Collection

1. **Collect SAML Assertion**: Secure the exact SAML assertion that generated the error. This is critical for diagnosis.

2. **Log User Attempts**: Keep a record of user attempts to authenticate, including timestamps, usernames, and the errors encountered.

3. **Capture IdP Logs**: If possible, gather logs from the identity provider to understand how it generated the SAML assertion.

4. **Provide Contextual Information**: Document any changes made prior to encountering the error, as well as any related configurations.

By following this guide, you should be able to identify the issue at hand and take the appropriate steps to resolve the AADSTS5000819 error.

Category: Other