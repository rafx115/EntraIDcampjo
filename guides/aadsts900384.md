# AADSTS900384: JWT token failed signature validation. Actual message content is runtime specific, there are a variety of causes for this error. Please see the returned exception message for details.


## Troubleshooting Steps
### Troubleshooting Guide for Error Code AADSTS900384

**Error Description**:  
AADSTS900384 indicates that a JSON Web Token (JWT) failed signature validation. This error can occur for various reasons, and resolving it may involve several diagnostic steps and modifications.

---

### Initial Diagnostic Steps

1. **Analyze the Exception Message**: Pay close attention to the detailed message included in the exception. It often contains clues about why the signature validation failed, such as issues with the signing key or token expiration.

2. **Identify the Token**: Determine which JWT token failed validation. Ensure you have access to the contents of the token, typically the header, payload, and signature.

3. **Check the Audience**: Confirm that the token's `aud` (audience) claim matches the expected audience of the resource you are attempting to access.

4. **Review Expiry and Not Before Claims**: Verify that the `exp` (expiration) and `nbf` (not before) claims in the JWT are valid for the current time.

5. **Inspect the Signing Algorithm**: Examine the `alg` (algorithm) claim in the token header to ensure it matches the settings expected by your application.

---

### Common Issues that Cause This Error

1. **Signature Key Mismatch**: The token was signed with a different key or certificate than what your application has configured.

2. **Token Expiration**: The token may have expired by the time it was validated.

3. **Incorrect Audience**: The token may not be intended for your application, as indicated by the `aud` claim.

4. **Token Format Issues**: The JWT may be malformed, affecting decoding and signature verification.

5. **Outdated Keys**: If using a cached signing key, it may have been revoked or changed.

---

### Step-by-Step Resolution Strategies

1. **Inspect the JWT Structure**: 
   - Decode the JWT using a JWT debugger (e.g., [jwt.io](https://jwt.io/)).
   - Verify that the structure of the token is correct: it should consist of three parts separated by dots (header, payload, signature).

2. **Check Signing Keys**:
   - Access the Azure portal and navigate to Azure Active Directory > App registrations.
   - Check the keys under *Certificates & secrets* to ensure they match the key used to sign the JWT.

3. **Verify Token Configuration**:
   - Ensure that the `aud` claims in the token match your application ID (client ID) or specific resource that you're accessing.
   - Review application settings for allowed token signing algorithms and ensure they align with the signed token.

4. **Validate Token Expiry**:
   - Check the `exp` claim to confirm that the token has not expired at the time of validation.
   - Re-authenticate to obtain a fresh token if needed.

5. **Update or Refresh Keys**:
   - If other services are maintaining a cache of the keys, refresh those caches.
   - You can reconfigure or refresh the signing keys in your app settings if required.

6. **Error Logging**:
   - Implement detailed logging around the token validation process to capture errors and context for further analysis.

---

### Additional Notes or Considerations

- **Multiple Token Versions**: If you have multiple authentication providers or versions of a service, ensure you are using the correct tokens for their respective services.

- **Be Wary of Time Synchronization**: If your server's clock is not synced, it could lead to premature token expiration or issues in validating the `nbf` claim. Ensure that NTP is correctly set up.

- **Use Libraries for Validation**: Utilize established libraries for token validation, as they typically handle many edge cases and best practices automatically. Examples include:
  - Microsoft Authentication Library (MSAL)
  - Auth0's libraries for various programming languages.

---

### Documentation References

- [Microsoft Authentication Library (MSAL) Overview](https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-overview)
- [Understanding JWT Token Validation](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-jwt-bearer)
- [Handling Token Expiration](https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens#expiration)

### Test the Documentation Reachability

To test, click the links above to ensure they are reachable and provide the necessary guidance.

### Advice for Data Collection

1. **Capture Token Values**: Collect logs from the application that include the JWT token when the error occurs (do not expose sensitive information).

2. **Inspect Application Endpoints**: Gather logs from any related backend services that might influence token generation or validation.

3. **Time Stamps**: Note the timestamps when the token is issued and when the validation fails to check for timing issues.

4. **Authentication Flow**: Document the entire authentication flow leading up to the error, including the identity provider settings.

---

Following these steps should help you diagnose and resolve the issue around the AADSTS900384 error effectively.